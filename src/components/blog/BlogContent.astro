---
import { getCollection, getEntries } from 'astro:content'
import { Image } from 'astro:assets'
import ArticleCard from './ArticleCard.astro'
import WithoutContent from '../WithoutContent.astro'
import NoContent from '@assets/nocontent.svg'

// Las content collections de Astro permiten recuperar datos de tres maneras:
// 1. getCollections() -> Obtiene una colección entera
// 2. getEntry() -> Recupera un elemento de una colección.
// 3. getEntries() -> Recupera uno o varios datos refenciados

async function getArticles() {
  const rawArticles = await getCollection('articles')
  const articles = rawArticles.map(async raw => {
    const rawAuthors = await getEntries(raw.data.authors)
    return {
      id: raw.id,
      data: {
        ...raw.data,
        authors: [...rawAuthors],
      },
    }
  })

  return Promise.allSettled(articles).then(results => results)
}

const allArticles = await getArticles()
---

<div
  id='Content'
  class='z-0 p-[1px] flex flex-col gap-4 md:grid md:grid-cols-2 md:gap-4 lg:pt-16 lg:grid-cols-1 lg:gap-12'>
  {
    allArticles &&
      allArticles.length !== 0 &&
      allArticles.map(results => {
        return results.status !== 'fulfilled' ? (
          <WithoutContent data-card-category={'no-content'} />
        ) : (
          <ArticleCard
            href={`blog/${results.value.id}`}
            title={results.value.data.title}
            date={results.value.data.pubDate}
            tag={results.value.data.category.id}
            thumbnail={results.value.data.thumbnail}
            class='hidden lg:h-80 xl:h-96'
            data-card-category={results.value.data.category.id}
          />
        )
      })
  }
  <Image id='NoContent' class='hidden m-auto' src={NoContent} alt='' />
</div>

<script>
  import { toggleActiveCard, checkVisibleCards } from '@lib/dom/blog'
  import type { UrlChangeEventData } from '@custom-types/global'

  const cards = document.querySelectorAll('a[data-card-category], div[data-card-category]')

  // Por defecto las etiquetas script en Astro esperan a que sea cargue todo el HTML, de esta manera no se necesita del evento "load"
  function syncUIByUrlParams(
    nodes: NodeListOf<Element>,
    currentFilter?: string | null | undefined,
  ) {
    const filter = currentFilter || new URL(window.location.href).searchParams.get('category')
    toggleActiveCard(nodes, filter)
  }

  syncUIByUrlParams(cards)
  checkVisibleCards(cards)

  window.addEventListener('changeUrl', e => {
    const changeUrlEvent = e as CustomEvent<UrlChangeEventData> // Type assertion
    syncUIByUrlParams(cards, changeUrlEvent.detail.payload)
    checkVisibleCards(cards)
  })
</script>
