---
import { render } from 'astro:content'
import { getCollection } from 'astro:content'
import { getEntries } from 'astro:content'
import { getEntry } from 'astro:content'
import Layout from '@layouts/Layout.astro'
import ArticleLayout from '@layouts/ArticleLayout.astro'

export async function getStaticPaths() {
  const rawArticles = await getCollection('articles')

  const cleanArticles = rawArticles.map(async raw => {
    try {
      const rawArticle = await getEntry(raw)

      return {
        ...rawArticle,
        data: {
          ...rawArticle.data,
          relatedArticles: rawArticle.data.relatedArticles ? await getEntries(rawArticle.data.relatedArticles) : [],
        },
      }
    } catch (error) {
      console.error(error)
    }
  })

  const articles = await Promise.allSettled(cleanArticles).then(results =>
    results.filter(data => data.status === 'fulfilled').map(data => data.value),
  )

  return articles.map(article => {
    if (!article) return

    return {
      params: {
        slug: article.id,
      },
      props: {
        article: article,
      },
    }
  })
}

const { article } = Astro.props
const { Content, remarkPluginFrontmatter } = await render(article)
const {
  title,
  pubDate,
  authors,
  cover: { img, description },
  relatedArticles,
} = article.data
---

<Layout pageTitle={title}>
  <ArticleLayout
    title={title}
    pubDate={pubDate}
    authors={authors}
    readingTime={remarkPluginFrontmatter.minutesRead}
    cover={{ src: img, alt: description }}
    relatedArticles={relatedArticles}>
    <Content />
  </ArticleLayout>
</Layout>
